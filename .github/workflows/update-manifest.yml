name: Update Manifests

# Runs after each merge to main that touches firmware or SPIFFS binaries.
# Produces TWO independent manifests:
#   firmware/<device>.manifest.json  -- firmware versions only
#   spiffs/<device>.manifest.json    -- SPIFFS versions only
# Each manifest format:
#   { "latest": "x.y.z", "versions": [ { "version", "date", "notes", "url", "sha256" } ] }

on:
  push:
    branches: [main]
    paths:
      - "firmware/**/*.bin"
      - "spiffs/**/*.bin"

jobs:
  update-manifests:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate firmware and SPIFFS manifests
        run: |
          python3 - << 'PYEOF'
          import json, hashlib
          from pathlib import Path

          REPO     = "kubkpower/halloween_dmx_pub"
          BASE_URL = f"https://raw.githubusercontent.com/{REPO}/main"

          fw_root  = Path("firmware")
          sp_root  = Path("spiffs")
          cfg_root = Path("config")

          def sha256(path):
              h = hashlib.sha256()
              with open(path, "rb") as f:
                  for chunk in iter(lambda: f.read(65536), b""):
                      h.update(chunk)
              return h.hexdigest()

          def ver_key(p):
              name = p.name.lstrip("v")
              try:
                  return tuple(int(x) for x in name.split("."))
              except ValueError:
                  return (0, 0, 0)

          def read_meta(vdir, device):
              meta_file = vdir / "meta.json"
              if meta_file.exists():
                  try:
                      # PowerShell 5.1 writes UTF-8 with BOM; use utf-8-sig to strip it
                      m = json.loads(meta_file.read_text(encoding="utf-8-sig"))
                      return m.get("date", ""), m.get("notes", "")
                  except Exception:
                      pass
              cfg_file = cfg_root / device / "config.yaml"
              date, notes = "", ""
              if cfg_file.exists():
                  for line in cfg_file.read_text().splitlines():
                      if line.startswith("notes:"):
                          notes = line.split(":", 1)[1].strip().strip('"')
                      if line.startswith("built:"):
                          date  = line.split(":", 1)[1].strip().strip('"')
              return date, notes

          devices = sorted(p.name for p in fw_root.iterdir() if p.is_dir())

          for device in devices:
              dev_fw_dir = fw_root / device
              dev_sp_dir = sp_root / device

              vdirs = sorted(
                  (p for p in dev_fw_dir.iterdir() if p.is_dir() and p.name.startswith("v")),
                  key=ver_key, reverse=True
              )

              fw_versions = []
              sp_versions = []

              for vdir in vdirs:
                  ver  = vdir.name.lstrip("v")
                  date, notes = read_meta(vdir, device)

                  fw_bin = vdir / "firmware.bin"
                  if fw_bin.exists():
                      fw_versions.append({
                          "version": ver,
                          "date":    date,
                          "notes":   notes,
                          "url":     f"{BASE_URL}/firmware/{device}/{vdir.name}/firmware.bin",
                          "sha256":  sha256(fw_bin)
                      })

                  sp_bin = dev_sp_dir / vdir.name / "spiffs.bin"
                  if sp_bin.exists():
                      sp_versions.append({
                          "version": ver,
                          "date":    date,
                          "notes":   notes,
                          "url":     f"{BASE_URL}/spiffs/{device}/{vdir.name}/spiffs.bin",
                          "sha256":  sha256(sp_bin)
                      })

              if fw_versions:
                  fw_manifest = {"latest": fw_versions[0]["version"], "versions": fw_versions}
                  out = fw_root / f"{device}.manifest.json"
                  out.write_text(json.dumps(fw_manifest, indent=2, ensure_ascii=False) + "\n")
                  print(f"  [OK] {out}: {len(fw_versions)} fw version(s) -- latest {fw_manifest['latest']}")
              else:
                  print(f"  [skip] {device} -- no firmware binaries")

              if sp_versions:
                  sp_manifest = {"latest": sp_versions[0]["version"], "versions": sp_versions}
                  out = sp_root / f"{device}.manifest.json"
                  out.write_text(json.dumps(sp_manifest, indent=2, ensure_ascii=False) + "\n")
                  print(f"  [OK] {out}: {len(sp_versions)} sp version(s) -- latest {sp_manifest['latest']}")
              else:
                  print(f"  [skip] {device} -- no SPIFFS binaries")
          PYEOF

      - name: Commit & push updated manifests
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add firmware/*.manifest.json spiffs/*.manifest.json 2>/dev/null || true
          if git diff --cached --quiet; then
            echo "Manifests already up to date."
          else
            git commit -m "chore: update manifests [skip ci]"
            git push
          fi
